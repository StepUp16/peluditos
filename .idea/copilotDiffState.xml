<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/veterinaria/peluditos/admin_paciente_detalle.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/veterinaria/peluditos/admin_paciente_detalle.java" />
              <option name="originalContent" value="package com.veterinaria.peluditos;&#10;&#10;import android.content.Intent;&#10;import android.net.Uri;&#10;import android.os.Bundle;&#10;import android.text.TextUtils;&#10;import android.view.View;&#10;import android.widget.Button;&#10;import android.widget.ImageButton;&#10;import android.widget.ImageView;&#10;import android.widget.ProgressBar;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.activity.result.ActivityResultLauncher;&#10;import androidx.activity.result.contract.ActivityResultContracts;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.lifecycle.ViewModelProvider;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.bumptech.glide.Glide;&#10;import com.google.android.material.imageview.ShapeableImageView;&#10;import com.google.android.material.tabs.TabLayout;&#10;import com.veterinaria.peluditos.adapters.HistorialMedicoAdapter;&#10;import com.veterinaria.peluditos.adapters.PacienteCitaAdapter;&#10;import com.veterinaria.peluditos.data.Cita;&#10;import com.veterinaria.peluditos.data.HistorialMedico;&#10;import com.veterinaria.peluditos.data.Paciente;&#10;import com.veterinaria.peluditos.data.Usuario;&#10;import com.veterinaria.peluditos.util.NetworkUtils;&#10;import com.veterinaria.peluditos.util.PacientePhotoManager;&#10;&#10;import java.util.List;&#10;import java.util.Locale;&#10;&#10;public class admin_paciente_detalle extends AppCompatActivity {&#10;&#10;    public static final String EXTRA_PACIENTE_ID = &quot;extra_paciente_id&quot;;&#10;&#10;    private ShapeableImageView ivPatientPhoto;&#10;    private TextView tvPatientName;&#10;    private TextView tvPatientBreed;&#10;    private TextView tvPatientInfo;&#10;    private ShapeableImageView ivClientPhoto;&#10;    private TextView tvClientName;&#10;    private TextView tvClientPhone;&#10;    private Button btnEdit;&#10;    private Button btnAgregarHistorial;&#10;    private ImageButton btnChangePhoto;&#10;    private ProgressBar photoProgress;&#10;    private RecyclerView recyclerViewHistory;&#10;    private TextView tvEmptyHistorial;&#10;    private TabLayout tabLayout;&#10;&#10;    private HistorialMedicoAdapter historialAdapter;&#10;    private PacienteCitaAdapter citaAdapter;&#10;    private AdminPacienteViewModel pacienteViewModel;&#10;    private AdminHistorialMedicoViewModel historialMedicoViewModel;&#10;    private AdminUsuarioViewModel usuarioViewModel;&#10;    private AdminCitaViewModel citaViewModel;&#10;&#10;    private String pacienteId;&#10;    private Paciente pacienteActual;&#10;    private List&lt;HistorialMedico&gt; historialActual;&#10;    private List&lt;Cita&gt; citasFuturas;&#10;    private List&lt;Cita&gt; citasPasadas;&#10;    private PacientePhotoManager photoManager;&#10;    private ActivityResultLauncher&lt;String&gt; photoPickerLauncher;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.admin_paciente_detalle);&#10;&#10;        photoManager = new PacientePhotoManager();&#10;        photoPickerLauncher = registerForActivityResult(&#10;                new ActivityResultContracts.GetContent(),&#10;                uri -&gt; {&#10;                    if (uri != null) {&#10;                        subirFotoPaciente(uri);&#10;                    }&#10;                }&#10;        );&#10;&#10;        pacienteId = getIntent() != null ? getIntent().getStringExtra(EXTRA_PACIENTE_ID) : null;&#10;        if (TextUtils.isEmpty(pacienteId)) {&#10;            Toast.makeText(this, R.string.error_paciente, Toast.LENGTH_SHORT).show();&#10;            finish();&#10;            return;&#10;        }&#10;&#10;        initViews();&#10;        setupRecyclerView();&#10;        setupTabLayout();&#10;        setupBottomMenu();&#10;&#10;        pacienteViewModel = new ViewModelProvider(this).get(AdminPacienteViewModel.class);&#10;        historialMedicoViewModel = new ViewModelProvider(this).get(AdminHistorialMedicoViewModel.class);&#10;        usuarioViewModel = new ViewModelProvider(this).get(AdminUsuarioViewModel.class);&#10;        citaViewModel = new ViewModelProvider(this).get(AdminCitaViewModel.class);&#10;&#10;        pacienteViewModel.getPaciente(pacienteId).observe(this, paciente -&gt; {&#10;            if (paciente == null) {&#10;                Toast.makeText(this, R.string.error_paciente, Toast.LENGTH_SHORT).show();&#10;                finish();&#10;                return;&#10;            }&#10;            pacienteActual = paciente;&#10;            renderPaciente(paciente);&#10;        });&#10;&#10;        historialMedicoViewModel.getPorPaciente(pacienteId).observe(this, historiales -&gt; {&#10;            historialActual = historiales;&#10;            historialAdapter.setHistoriales(historiales);&#10;            updateEmptyState();&#10;        });&#10;&#10;        citaViewModel.getAllCitas().observe(this, citas -&gt; {&#10;            if (citas == null) {&#10;                citasFuturas = null;&#10;                citasPasadas = null;&#10;            } else {&#10;                long now = System.currentTimeMillis();&#10;                citasFuturas = new java.util.ArrayList&lt;&gt;();&#10;                citasPasadas = new java.util.ArrayList&lt;&gt;();&#10;                for (Cita cita : citas) {&#10;                    if (!TextUtils.equals(cita.getPacienteId(), pacienteId)) continue;&#10;                    long time = cita.getFechaHoraTimestamp();&#10;                    if (time &gt;= now) {&#10;                        citasFuturas.add(cita);&#10;                    } else {&#10;                        citasPasadas.add(cita);&#10;                    }&#10;                }&#10;            }&#10;            updateCitaAdapter();&#10;        });&#10;    }&#10;&#10;    private void initViews() {&#10;        ivPatientPhoto = findViewById(R.id.ivPatientPhoto);&#10;        tvPatientName = findViewById(R.id.tvPatientName);&#10;        tvPatientBreed = findViewById(R.id.tvPatientBreed);&#10;        tvPatientInfo = findViewById(R.id.tvPatientInfo);&#10;        ivClientPhoto = findViewById(R.id.ivClientPhoto);&#10;        tvClientName = findViewById(R.id.tvClientName);&#10;        tvClientPhone = findViewById(R.id.tvClientPhone);&#10;        btnEdit = findViewById(R.id.btnEdit);&#10;        btnAgregarHistorial = findViewById(R.id.btnAgregarHistorial);&#10;        recyclerViewHistory = findViewById(R.id.recyclerViewHistory);&#10;        tvEmptyHistorial = findViewById(R.id.tvEmptyHistorial);&#10;        tabLayout = findViewById(R.id.tabLayout);&#10;        ImageButton btnBack = findViewById(R.id.btnBack);&#10;        btnChangePhoto = findViewById(R.id.btnChangePhoto);&#10;        photoProgress = findViewById(R.id.photoProgress);&#10;&#10;        btnBack.setOnClickListener(v -&gt; finish());&#10;        btnEdit.setOnClickListener(v -&gt; abrirEditarPaciente());&#10;        btnAgregarHistorial.setOnClickListener(v -&gt; abrirHistorialMedico());&#10;        if (btnChangePhoto != null) {&#10;            btnChangePhoto.setOnClickListener(v -&gt; seleccionarNuevaFoto());&#10;        }&#10;    }&#10;&#10;    private void setupRecyclerView() {&#10;        historialAdapter = new HistorialMedicoAdapter();&#10;        citaAdapter = new PacienteCitaAdapter();&#10;        recyclerViewHistory.setLayoutManager(new LinearLayoutManager(this));&#10;        recyclerViewHistory.setAdapter(historialAdapter);&#10;    }&#10;&#10;    private void setupTabLayout() {&#10;        tabLayout.addOnTabSelectedListener(new TabLayout.OnTabSelectedListener() {&#10;            @Override&#10;            public void onTabSelected(TabLayout.Tab tab) {&#10;                manejarSeleccionTab(tab.getPosition());&#10;            }&#10;&#10;            @Override&#10;            public void onTabUnselected(TabLayout.Tab tab) { }&#10;&#10;            @Override&#10;            public void onTabReselected(TabLayout.Tab tab) { }&#10;        });&#10;        manejarSeleccionTab(0);&#10;    }&#10;&#10;    private void setupBottomMenu() {&#10;        ImageView iconHome = findViewById(R.id.iconHome);&#10;        ImageView iconClientes = findViewById(R.id.iconClientes);&#10;        ImageView iconPacientes = findViewById(R.id.iconPacientes);&#10;        ImageView iconCitas = findViewById(R.id.iconCitas);&#10;        ImageView iconPerfil = findViewById(R.id.iconPerfil);&#10;&#10;        if (iconHome != null &amp;&amp; iconHome.getParent() instanceof View) {&#10;            View homeView = (View) iconHome.getParent();&#10;            homeView.setOnClickListener(v -&gt; {&#10;                Intent intent = new Intent(this, admin_home.class);&#10;                intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;            });&#10;        }&#10;&#10;        if (iconClientes != null &amp;&amp; iconClientes.getParent() instanceof View) {&#10;            View clientesView = (View) iconClientes.getParent();&#10;            clientesView.setOnClickListener(v -&gt; {&#10;                Intent intent = new Intent(this, AdminUsuarioClienteListadoActivity.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;            });&#10;        }&#10;&#10;        if (iconPacientes != null &amp;&amp; iconPacientes.getParent() instanceof View) {&#10;            View pacientesView = (View) iconPacientes.getParent();&#10;            pacientesView.setOnClickListener(v -&gt; {&#10;                Intent intent = new Intent(this, AdminPacienteListadoActivity.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;            });&#10;        }&#10;&#10;        if (iconCitas != null &amp;&amp; iconCitas.getParent() instanceof View) {&#10;            View citasView = (View) iconCitas.getParent();&#10;            citasView.setOnClickListener(v -&gt; {&#10;                Intent intent = new Intent(this, admin_cita_listado.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;            });&#10;        }&#10;&#10;        if (iconPerfil != null &amp;&amp; iconPerfil.getParent() instanceof View) {&#10;            View perfilView = (View) iconPerfil.getParent();&#10;            perfilView.setOnClickListener(v -&gt; {&#10;                Intent intent = new Intent(this, AdminPerfil.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;            });&#10;        }&#10;    }&#10;&#10;    private void startActivityWithAnimation(Intent intent) {&#10;        startActivity(intent);&#10;        overridePendingTransition(R.anim.slide_in_right, R.anim.slide_out_left);&#10;    }&#10;&#10;    @Override&#10;    public void finish() {&#10;        super.finish();&#10;        overridePendingTransition(R.anim.slide_in_left, R.anim.slide_out_right);&#10;    }&#10;&#10;    private void renderPaciente(Paciente paciente) {&#10;        tvPatientName.setText(paciente.getNombre());&#10;&#10;        String especie = !TextUtils.isEmpty(paciente.getEspecie()) ? paciente.getEspecie() : &quot;-&quot;;&#10;        String raza = !TextUtils.isEmpty(paciente.getRaza()) ? paciente.getRaza() : &quot;&quot;;&#10;        tvPatientBreed.setText(raza.isEmpty() ? especie : especie + &quot;, &quot; + raza);&#10;&#10;        String info = String.format(Locale.getDefault(),&#10;                &quot;Edad: %d %s, Sexo: %s&quot;,&#10;                paciente.getEdad(),&#10;                paciente.getEdad() == 1 ? &quot;año&quot; : &quot;años&quot;,&#10;                !TextUtils.isEmpty(paciente.getSexo()) ? paciente.getSexo() : &quot;-&quot;);&#10;        tvPatientInfo.setText(info);&#10;&#10;        tvClientName.setText(!TextUtils.isEmpty(paciente.getClienteNombre())&#10;                ? paciente.getClienteNombre()&#10;                : getString(R.string.paciente_sin_cliente));&#10;        cargarTelefonoCliente(paciente.getClienteId());&#10;&#10;        loadPacientePhoto(paciente.getFotoUrl());&#10;        ivClientPhoto.setImageResource(R.drawable.user_sofia);&#10;    }&#10;&#10;    private void cargarTelefonoCliente(String clienteId) {&#10;        if (TextUtils.isEmpty(clienteId)) {&#10;            tvClientPhone.setText(R.string.msg_seleccione_cliente);&#10;            return;&#10;        }&#10;        usuarioViewModel.getUsuario(clienteId).observe(this, usuario -&gt; {&#10;            if (usuario != null &amp;&amp; !TextUtils.isEmpty(usuario.getTelefono())) {&#10;                tvClientPhone.setText(getString(R.string.cliente_telefono_formato, usuario.getTelefono()));&#10;            } else {&#10;                tvClientPhone.setText(R.string.msg_seleccione_cliente);&#10;            }&#10;        });&#10;    }&#10;&#10;    private void manejarSeleccionTab(int position) {&#10;        if (position == 0) {&#10;            recyclerViewHistory.setVisibility(View.VISIBLE);&#10;            btnAgregarHistorial.setVisibility(View.VISIBLE);&#10;            recyclerViewHistory.setAdapter(historialAdapter);&#10;        } else {&#10;            recyclerViewHistory.setVisibility(View.VISIBLE);&#10;            btnAgregarHistorial.setVisibility(View.GONE);&#10;            recyclerViewHistory.setAdapter(citaAdapter);&#10;            updateCitaAdapter();&#10;        }&#10;        updateEmptyState();&#10;    }&#10;&#10;    private void updateEmptyState() {&#10;        if (tabLayout.getSelectedTabPosition() != 0) {&#10;            boolean isEmpty;&#10;            if (tabLayout.getSelectedTabPosition() == 1) {&#10;                isEmpty = citasFuturas == null || citasFuturas.isEmpty();&#10;                tvEmptyHistorial.setText(R.string.empty_citas_futuras);&#10;            } else {&#10;                isEmpty = citasPasadas == null || citasPasadas.isEmpty();&#10;                tvEmptyHistorial.setText(R.string.empty_citas_pasadas);&#10;            }&#10;            tvEmptyHistorial.setVisibility(isEmpty ? View.VISIBLE : View.GONE);&#10;            return;&#10;        }&#10;        boolean isEmpty = historialActual == null || historialActual.isEmpty();&#10;        tvEmptyHistorial.setVisibility(isEmpty ? View.VISIBLE : View.GONE);&#10;        if (isEmpty) {&#10;            tvEmptyHistorial.setText(R.string.empty_historial);&#10;        }&#10;    }&#10;&#10;    private void updateCitaAdapter() {&#10;        if (tabLayout == null || citaAdapter == null) {&#10;            return;&#10;        }&#10;        if (tabLayout.getSelectedTabPosition() == 1) {&#10;            citaAdapter.setCitas(citasFuturas);&#10;        } else if (tabLayout.getSelectedTabPosition() == 2) {&#10;            citaAdapter.setCitas(citasPasadas);&#10;        } else {&#10;            return;&#10;        }&#10;        updateEmptyState();&#10;    }&#10;&#10;    private void abrirEditarPaciente() {&#10;        if (pacienteActual == null) {&#10;            return;&#10;        }&#10;        Intent intent = new Intent(this, AdminPacienteEditarActivity.class);&#10;        intent.putExtra(AdminPacienteEditarActivity.EXTRA_PACIENTE_ID, pacienteActual.getId());&#10;        startActivity(intent);&#10;    }&#10;&#10;    private void abrirHistorialMedico() {&#10;        Intent intent = new Intent(this, admin_historial_medico.class);&#10;        intent.putExtra(admin_historial_medico.EXTRA_PACIENTE_ID, pacienteId);&#10;        intent.putExtra(admin_historial_medico.EXTRA_PACIENTE_NOMBRE,&#10;                pacienteActual != null ? pacienteActual.getNombre() : &quot;&quot;);&#10;        startActivity(intent);&#10;    }&#10;&#10;    private void seleccionarNuevaFoto() {&#10;        if (pacienteActual == null) {&#10;            Toast.makeText(this, R.string.error_paciente, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        if (!NetworkUtils.isOnline(this)) {&#10;            Toast.makeText(this, R.string.error_red_requerida, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        if (photoPickerLauncher != null) {&#10;            photoPickerLauncher.launch(&quot;image/*&quot;);&#10;        }&#10;    }&#10;&#10;    private void subirFotoPaciente(Uri uri) {&#10;        if (pacienteId == null || photoManager == null) {&#10;            return;&#10;        }&#10;        mostrarCargaFoto(true);&#10;        Toast.makeText(this, R.string.msg_foto_subiendo, Toast.LENGTH_SHORT).show();&#10;        photoManager.uploadPhoto(getApplicationContext(), uri, pacienteId,&#10;                new PacientePhotoManager.UploadCallback() {&#10;                    @Override&#10;                    public void onSuccess(@androidx.annotation.NonNull String downloadUrl) {&#10;                        if (pacienteActual != null) {&#10;                            pacienteActual.setFotoUrl(downloadUrl);&#10;                            pacienteViewModel.update(pacienteActual);&#10;                            loadPacientePhoto(downloadUrl);&#10;                        }&#10;                        mostrarCargaFoto(false);&#10;                        Toast.makeText(admin_paciente_detalle.this,&#10;                                R.string.msg_foto_actualizada,&#10;                                Toast.LENGTH_SHORT).show();&#10;                    }&#10;&#10;                    @Override&#10;                    public void onError(@androidx.annotation.NonNull Exception exception) {&#10;                        mostrarCargaFoto(false);&#10;                        Toast.makeText(admin_paciente_detalle.this,&#10;                                R.string.error_subir_foto,&#10;                                Toast.LENGTH_SHORT).show();&#10;                    }&#10;                });&#10;    }&#10;&#10;    private void mostrarCargaFoto(boolean mostrando) {&#10;        if (photoProgress != null) {&#10;            photoProgress.setVisibility(mostrando ? View.VISIBLE : View.GONE);&#10;        }&#10;        if (btnChangePhoto != null) {&#10;            btnChangePhoto.setEnabled(!mostrando);&#10;            btnChangePhoto.setAlpha(mostrando ? 0.4f : 1f);&#10;        }&#10;    }&#10;&#10;    private void loadPacientePhoto(String fotoUrl) {&#10;        if (TextUtils.isEmpty(fotoUrl)) {&#10;            ivPatientPhoto.setImageResource(R.drawable.paciente);&#10;            return;&#10;        }&#10;        Glide.with(this)&#10;                .load(fotoUrl)&#10;                .placeholder(R.drawable.paciente)&#10;                .error(R.drawable.paciente)&#10;                .into(ivPatientPhoto);&#10;    }&#10;&#10;    @Override&#10;    protected void onDestroy() {&#10;        super.onDestroy();&#10;        if (photoManager != null) {&#10;            photoManager.dispose();&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.veterinaria.peluditos;&#10;&#10;import android.content.Intent;&#10;import android.net.Uri;&#10;import android.os.Bundle;&#10;import android.text.TextUtils;&#10;import android.view.View;&#10;import android.widget.Button;&#10;import android.widget.ImageButton;&#10;import android.widget.ImageView;&#10;import android.widget.ProgressBar;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.activity.result.ActivityResultLauncher;&#10;import androidx.activity.result.contract.ActivityResultContracts;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;import androidx.lifecycle.ViewModelProvider;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import com.bumptech.glide.Glide;&#10;import com.google.android.material.bottomnavigation.BottomNavigationView;&#10;import com.google.android.material.imageview.ShapeableImageView;&#10;import com.google.android.material.tabs.TabLayout;&#10;import com.veterinaria.peluditos.adapters.HistorialMedicoAdapter;&#10;import com.veterinaria.peluditos.adapters.PacienteCitaAdapter;&#10;import com.veterinaria.peluditos.data.Cita;&#10;import com.veterinaria.peluditos.data.HistorialMedico;&#10;import com.veterinaria.peluditos.data.Paciente;&#10;import com.veterinaria.peluditos.data.Usuario;&#10;import com.veterinaria.peluditos.util.NetworkUtils;&#10;import com.veterinaria.peluditos.util.PacientePhotoManager;&#10;&#10;import java.util.List;&#10;import java.util.Locale;&#10;&#10;public class admin_paciente_detalle extends AppCompatActivity {&#10;&#10;    public static final String EXTRA_PACIENTE_ID = &quot;extra_paciente_id&quot;;&#10;&#10;    private ShapeableImageView ivPatientPhoto;&#10;    private TextView tvPatientName;&#10;    private TextView tvPatientBreed;&#10;    private TextView tvPatientInfo;&#10;    private ShapeableImageView ivClientPhoto;&#10;    private TextView tvClientName;&#10;    private TextView tvClientPhone;&#10;    private Button btnEdit;&#10;    private Button btnAgregarHistorial;&#10;    private ImageButton btnChangePhoto;&#10;    private ProgressBar photoProgress;&#10;    private RecyclerView recyclerViewHistory;&#10;    private TextView tvEmptyHistorial;&#10;    private TabLayout tabLayout;&#10;&#10;    private HistorialMedicoAdapter historialAdapter;&#10;    private PacienteCitaAdapter citaAdapter;&#10;    private AdminPacienteViewModel pacienteViewModel;&#10;    private AdminHistorialMedicoViewModel historialMedicoViewModel;&#10;    private AdminUsuarioViewModel usuarioViewModel;&#10;    private AdminCitaViewModel citaViewModel;&#10;&#10;    private String pacienteId;&#10;    private Paciente pacienteActual;&#10;    private List&lt;HistorialMedico&gt; historialActual;&#10;    private List&lt;Cita&gt; citasFuturas;&#10;    private List&lt;Cita&gt; citasPasadas;&#10;    private PacientePhotoManager photoManager;&#10;    private ActivityResultLauncher&lt;String&gt; photoPickerLauncher;&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.admin_paciente_detalle);&#10;&#10;        photoManager = new PacientePhotoManager();&#10;        photoPickerLauncher = registerForActivityResult(&#10;                new ActivityResultContracts.GetContent(),&#10;                uri -&gt; {&#10;                    if (uri != null) {&#10;                        subirFotoPaciente(uri);&#10;                    }&#10;                }&#10;        );&#10;&#10;        pacienteId = getIntent() != null ? getIntent().getStringExtra(EXTRA_PACIENTE_ID) : null;&#10;        if (TextUtils.isEmpty(pacienteId)) {&#10;            Toast.makeText(this, R.string.error_paciente, Toast.LENGTH_SHORT).show();&#10;            finish();&#10;            return;&#10;        }&#10;&#10;        initViews();&#10;        setupRecyclerView();&#10;        setupTabLayout();&#10;        setupBottomMenu();&#10;&#10;        pacienteViewModel = new ViewModelProvider(this).get(AdminPacienteViewModel.class);&#10;        historialMedicoViewModel = new ViewModelProvider(this).get(AdminHistorialMedicoViewModel.class);&#10;        usuarioViewModel = new ViewModelProvider(this).get(AdminUsuarioViewModel.class);&#10;        citaViewModel = new ViewModelProvider(this).get(AdminCitaViewModel.class);&#10;&#10;        pacienteViewModel.getPaciente(pacienteId).observe(this, paciente -&gt; {&#10;            if (paciente == null) {&#10;                Toast.makeText(this, R.string.error_paciente, Toast.LENGTH_SHORT).show();&#10;                finish();&#10;                return;&#10;            }&#10;            pacienteActual = paciente;&#10;            renderPaciente(paciente);&#10;        });&#10;&#10;        historialMedicoViewModel.getPorPaciente(pacienteId).observe(this, historiales -&gt; {&#10;            historialActual = historiales;&#10;            historialAdapter.setHistoriales(historiales);&#10;            updateEmptyState();&#10;        });&#10;&#10;        citaViewModel.getAllCitas().observe(this, citas -&gt; {&#10;            if (citas == null) {&#10;                citasFuturas = null;&#10;                citasPasadas = null;&#10;            } else {&#10;                long now = System.currentTimeMillis();&#10;                citasFuturas = new java.util.ArrayList&lt;&gt;();&#10;                citasPasadas = new java.util.ArrayList&lt;&gt;();&#10;                for (Cita cita : citas) {&#10;                    if (!TextUtils.equals(cita.getPacienteId(), pacienteId)) continue;&#10;                    long time = cita.getFechaHoraTimestamp();&#10;                    if (time &gt;= now) {&#10;                        citasFuturas.add(cita);&#10;                    } else {&#10;                        citasPasadas.add(cita);&#10;                    }&#10;                }&#10;            }&#10;            updateCitaAdapter();&#10;        });&#10;    }&#10;&#10;    private void initViews() {&#10;        ivPatientPhoto = findViewById(R.id.ivPatientPhoto);&#10;        tvPatientName = findViewById(R.id.tvPatientName);&#10;        tvPatientBreed = findViewById(R.id.tvPatientBreed);&#10;        tvPatientInfo = findViewById(R.id.tvPatientInfo);&#10;        ivClientPhoto = findViewById(R.id.ivClientPhoto);&#10;        tvClientName = findViewById(R.id.tvClientName);&#10;        tvClientPhone = findViewById(R.id.tvClientPhone);&#10;        btnEdit = findViewById(R.id.btnEdit);&#10;        btnAgregarHistorial = findViewById(R.id.btnAgregarHistorial);&#10;        recyclerViewHistory = findViewById(R.id.recyclerViewHistory);&#10;        tvEmptyHistorial = findViewById(R.id.tvEmptyHistorial);&#10;        tabLayout = findViewById(R.id.tabLayout);&#10;        ImageButton btnBack = findViewById(R.id.btnBack);&#10;        btnChangePhoto = findViewById(R.id.btnChangePhoto);&#10;        photoProgress = findViewById(R.id.photoProgress);&#10;&#10;        btnBack.setOnClickListener(v -&gt; finish());&#10;        btnEdit.setOnClickListener(v -&gt; abrirEditarPaciente());&#10;        btnAgregarHistorial.setOnClickListener(v -&gt; abrirHistorialMedico());&#10;        if (btnChangePhoto != null) {&#10;            btnChangePhoto.setOnClickListener(v -&gt; seleccionarNuevaFoto());&#10;        }&#10;    }&#10;&#10;    private void setupRecyclerView() {&#10;        historialAdapter = new HistorialMedicoAdapter();&#10;        citaAdapter = new PacienteCitaAdapter();&#10;        recyclerViewHistory.setLayoutManager(new LinearLayoutManager(this));&#10;        recyclerViewHistory.setAdapter(historialAdapter);&#10;    }&#10;&#10;    private void setupTabLayout() {&#10;        tabLayout.addOnTabSelectedListener(new TabLayout.OnTabSelectedListener() {&#10;            @Override&#10;            public void onTabSelected(TabLayout.Tab tab) {&#10;                manejarSeleccionTab(tab.getPosition());&#10;            }&#10;&#10;            @Override&#10;            public void onTabUnselected(TabLayout.Tab tab) { }&#10;&#10;            @Override&#10;            public void onTabReselected(TabLayout.Tab tab) { }&#10;        });&#10;        manejarSeleccionTab(0);&#10;    }&#10;&#10;    private void setupBottomMenu() {&#10;        BottomNavigationView bottomNav = findViewById(R.id.bottomMenu);&#10;        bottomNav.setSelectedItemId(R.id.iconPacientes);&#10;        bottomNav.setOnItemSelectedListener(item -&gt; {&#10;            int itemId = item.getItemId();&#10;            if (itemId == R.id.iconHome) {&#10;                Intent intent = new Intent(this, admin_home.class);&#10;                intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;                return true;&#10;            } else if (itemId == R.id.iconCitas) {&#10;                Intent intent = new Intent(this, admin_cita_listado.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;                return true;&#10;            } else if (itemId == R.id.iconPacientes) {&#10;                // Ya estás en la pantalla de detalle de paciente, no hacer nada&#10;                return true;&#10;            } else if (itemId == R.id.iconClientes) {&#10;                Intent intent = new Intent(this, AdminUsuarioClienteListadoActivity.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;                return true;&#10;            } else if (itemId == R.id.iconPerfil) {&#10;                Intent intent = new Intent(this, AdminPerfil.class);&#10;                startActivityWithAnimation(intent);&#10;                finish();&#10;                return true;&#10;            }&#10;            return false;&#10;        });&#10;    }&#10;&#10;    private void startActivityWithAnimation(Intent intent) {&#10;        startActivity(intent);&#10;        overridePendingTransition(R.anim.slide_in_right, R.anim.slide_out_left);&#10;    }&#10;&#10;    @Override&#10;    public void finish() {&#10;        super.finish();&#10;        overridePendingTransition(R.anim.slide_in_left, R.anim.slide_out_right);&#10;    }&#10;&#10;    private void renderPaciente(Paciente paciente) {&#10;        tvPatientName.setText(paciente.getNombre());&#10;&#10;        String especie = !TextUtils.isEmpty(paciente.getEspecie()) ? paciente.getEspecie() : &quot;-&quot;;&#10;        String raza = !TextUtils.isEmpty(paciente.getRaza()) ? paciente.getRaza() : &quot;&quot;;&#10;        tvPatientBreed.setText(raza.isEmpty() ? especie : especie + &quot;, &quot; + raza);&#10;&#10;        String info = String.format(Locale.getDefault(),&#10;                &quot;Edad: %d %s, Sexo: %s&quot;,&#10;                paciente.getEdad(),&#10;                paciente.getEdad() == 1 ? &quot;año&quot; : &quot;años&quot;,&#10;                !TextUtils.isEmpty(paciente.getSexo()) ? paciente.getSexo() : &quot;-&quot;);&#10;        tvPatientInfo.setText(info);&#10;&#10;        tvClientName.setText(!TextUtils.isEmpty(paciente.getClienteNombre())&#10;                ? paciente.getClienteNombre()&#10;                : getString(R.string.paciente_sin_cliente));&#10;        cargarTelefonoCliente(paciente.getClienteId());&#10;&#10;        loadPacientePhoto(paciente.getFotoUrl());&#10;        ivClientPhoto.setImageResource(R.drawable.user_sofia);&#10;    }&#10;&#10;    private void cargarTelefonoCliente(String clienteId) {&#10;        if (TextUtils.isEmpty(clienteId)) {&#10;            tvClientPhone.setText(R.string.msg_seleccione_cliente);&#10;            return;&#10;        }&#10;        usuarioViewModel.getUsuario(clienteId).observe(this, usuario -&gt; {&#10;            if (usuario != null &amp;&amp; !TextUtils.isEmpty(usuario.getTelefono())) {&#10;                tvClientPhone.setText(getString(R.string.cliente_telefono_formato, usuario.getTelefono()));&#10;            } else {&#10;                tvClientPhone.setText(R.string.msg_seleccione_cliente);&#10;            }&#10;        });&#10;    }&#10;&#10;    private void manejarSeleccionTab(int position) {&#10;        if (position == 0) {&#10;            recyclerViewHistory.setVisibility(View.VISIBLE);&#10;            btnAgregarHistorial.setVisibility(View.VISIBLE);&#10;            recyclerViewHistory.setAdapter(historialAdapter);&#10;        } else {&#10;            recyclerViewHistory.setVisibility(View.VISIBLE);&#10;            btnAgregarHistorial.setVisibility(View.GONE);&#10;            recyclerViewHistory.setAdapter(citaAdapter);&#10;            updateCitaAdapter();&#10;        }&#10;        updateEmptyState();&#10;    }&#10;&#10;    private void updateEmptyState() {&#10;        if (tabLayout.getSelectedTabPosition() != 0) {&#10;            boolean isEmpty;&#10;            if (tabLayout.getSelectedTabPosition() == 1) {&#10;                isEmpty = citasFuturas == null || citasFuturas.isEmpty();&#10;                tvEmptyHistorial.setText(R.string.empty_citas_futuras);&#10;            } else {&#10;                isEmpty = citasPasadas == null || citasPasadas.isEmpty();&#10;                tvEmptyHistorial.setText(R.string.empty_citas_pasadas);&#10;            }&#10;            tvEmptyHistorial.setVisibility(isEmpty ? View.VISIBLE : View.GONE);&#10;            return;&#10;        }&#10;        boolean isEmpty = historialActual == null || historialActual.isEmpty();&#10;        tvEmptyHistorial.setVisibility(isEmpty ? View.VISIBLE : View.GONE);&#10;        if (isEmpty) {&#10;            tvEmptyHistorial.setText(R.string.empty_historial);&#10;        }&#10;    }&#10;&#10;    private void updateCitaAdapter() {&#10;        if (tabLayout == null || citaAdapter == null) {&#10;            return;&#10;        }&#10;        if (tabLayout.getSelectedTabPosition() == 1) {&#10;            citaAdapter.setCitas(citasFuturas);&#10;        } else if (tabLayout.getSelectedTabPosition() == 2) {&#10;            citaAdapter.setCitas(citasPasadas);&#10;        } else {&#10;            return;&#10;        }&#10;        updateEmptyState();&#10;    }&#10;&#10;    private void abrirEditarPaciente() {&#10;        if (pacienteActual == null) {&#10;            return;&#10;        }&#10;        Intent intent = new Intent(this, AdminPacienteEditarActivity.class);&#10;        intent.putExtra(AdminPacienteEditarActivity.EXTRA_PACIENTE_ID, pacienteActual.getId());&#10;        startActivity(intent);&#10;    }&#10;&#10;    private void abrirHistorialMedico() {&#10;        Intent intent = new Intent(this, admin_historial_medico.class);&#10;        intent.putExtra(admin_historial_medico.EXTRA_PACIENTE_ID, pacienteId);&#10;        intent.putExtra(admin_historial_medico.EXTRA_PACIENTE_NOMBRE,&#10;                pacienteActual != null ? pacienteActual.getNombre() : &quot;&quot;);&#10;        startActivity(intent);&#10;    }&#10;&#10;    private void seleccionarNuevaFoto() {&#10;        if (pacienteActual == null) {&#10;            Toast.makeText(this, R.string.error_paciente, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        if (!NetworkUtils.isOnline(this)) {&#10;            Toast.makeText(this, R.string.error_red_requerida, Toast.LENGTH_SHORT).show();&#10;            return;&#10;        }&#10;        if (photoPickerLauncher != null) {&#10;            photoPickerLauncher.launch(&quot;image/*&quot;);&#10;        }&#10;    }&#10;&#10;    private void subirFotoPaciente(Uri uri) {&#10;        if (pacienteId == null || photoManager == null) {&#10;            return;&#10;        }&#10;        mostrarCargaFoto(true);&#10;        Toast.makeText(this, R.string.msg_foto_subiendo, Toast.LENGTH_SHORT).show();&#10;        photoManager.uploadPhoto(getApplicationContext(), uri, pacienteId,&#10;                new PacientePhotoManager.UploadCallback() {&#10;                    @Override&#10;                    public void onSuccess(@androidx.annotation.NonNull String downloadUrl) {&#10;                        if (pacienteActual != null) {&#10;                            pacienteActual.setFotoUrl(downloadUrl);&#10;                            pacienteViewModel.update(pacienteActual);&#10;                            loadPacientePhoto(downloadUrl);&#10;                        }&#10;                        mostrarCargaFoto(false);&#10;                        Toast.makeText(admin_paciente_detalle.this,&#10;                                R.string.msg_foto_actualizada,&#10;                                Toast.LENGTH_SHORT).show();&#10;                    }&#10;&#10;                    @Override&#10;                    public void onError(@androidx.annotation.NonNull Exception exception) {&#10;                        mostrarCargaFoto(false);&#10;                        Toast.makeText(admin_paciente_detalle.this,&#10;                                R.string.error_subir_foto,&#10;                                Toast.LENGTH_SHORT).show();&#10;                    }&#10;                });&#10;    }&#10;&#10;    private void mostrarCargaFoto(boolean mostrando) {&#10;        if (photoProgress != null) {&#10;            photoProgress.setVisibility(mostrando ? View.VISIBLE : View.GONE);&#10;        }&#10;        if (btnChangePhoto != null) {&#10;            btnChangePhoto.setEnabled(!mostrando);&#10;            btnChangePhoto.setAlpha(mostrando ? 0.4f : 1f);&#10;        }&#10;    }&#10;&#10;    private void loadPacientePhoto(String fotoUrl) {&#10;        if (TextUtils.isEmpty(fotoUrl)) {&#10;            ivPatientPhoto.setImageResource(R.drawable.paciente);&#10;            return;&#10;        }&#10;        Glide.with(this)&#10;                .load(fotoUrl)&#10;                .placeholder(R.drawable.paciente)&#10;                .error(R.drawable.paciente)&#10;                .into(ivPatientPhoto);&#10;    }&#10;&#10;    @Override&#10;    protected void onDestroy() {&#10;        super.onDestroy();&#10;        if (photoManager != null) {&#10;            photoManager.dispose();&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>